# Go CI ツール ドメイン設計

## ツールの本質

**このツールはGoテスト実行のラッパーである。**

本ツールは、Go言語の標準テストコマンド（`go test`）を効率的に実行するための制御ツールである。内部でメモリやデータを保持せず、以下の制御に特化する：

1. **実行ファイル数の制御** - 全体実行 or ディレクトリ単位分割
2. **実行時のLOG_LEVEL制御** - 通常実行 or debug実行の切替
3. **実行順序の制御** - エラー時の中断と類似テスト検索

重要な点：
- ツール内部にメモリは持たない（ステートレス）
- 解析処理はファイル・ディレクトリ把握のみ
- ログはGoテストの出力をそのまま流す
- エラー判定はGoテストの終了コードに基づく

## 設計哲学

### 中心極限定理による境界線導出

**何度も出現する要素は、ドメインの中心である。**

ドメイン境界線分析では、「出現分布」と「中心骨格」を全体図とし、「ライフサイクル」の異なる「イベント」を境界として設定した。中心極限定理に従い、要件と実装の両面で高頻度出現する要素を中心核とし、その周辺に分布する関連要素を同一ドメインに集約する。

### ユースケース要求への対応

要求事項から導出される3つの最重要指標：
1. **CI完了速度の向上** - 全体テストの即時pass判定
2. **詳細分析精度の向上** - ディレクトリ単位での段階的エラー特定
3. **問題把握容易性の向上** - 類似テストの並行実行とdebugログ出力

これらの要求が、以下のドメイン分離を正当化する。

### 6つのドメイン分離の根拠

出現分布分析により、以下の6つの独立した中心分布が確認された：

1. **CLI解析・設定構築** の最重要性（24/24 頻度）
2. **テスト実行・パイプライン制御** の最重要性（24/24 頻度）  
3. **エラー判定・実行制御** の実装重要性（20/24 → 24/24）
4. **ディレクトリ・ファイル管理** の基盤重要性（16/24, 20/24）
5. **検索・外部連携** の拡張性（8/24, 8/24）
6. **実行環境制御** の横断重要性（24/24 頻度）

この分布は、Goテスト実行ラッパーとしての責任を明確に分離し、内部メモリや複雑な解析処理を持たないステートレスな設計を実現する。

## ドメイン設計原理

### 全域性原則の適用

各ドメインで部分関数を全域関数に変換し、型システムで「ありえない状態」を排除する：

- **Result型**: 例外を値として表現し、エラー処理を型安全に
- **Discriminated Union**: オプショナルプロパティを状態ベースで表現
- **Smart Constructor**: 制約のある値をプライベートコンストラクタで保護
- **網羅的分岐**: switch文によるコンパイル時の全状態処理保証

### ライフサイクル分離戦略

境界線分析で特定された4つのライフサイクルを異なるドメインに分離：

- **永続的要素**（プロセス全体）: アプリケーション制御ドメイン
- **セッション要素**（実行セッション）: テスト実行エンジン、エラー処理ドメイン
- **一時的要素**（ステージ・タスク）: ファイル・リソース管理ドメイン
- **外部依存要素**（オンデマンド）: 検索・統合・拡張機能ドメイン

## 1. アプリケーション制御ドメイン

### なぜこのドメインを分けたのか

**永続性と制御権の集中**: CLI解析完了から終了まで、アプリケーション全体の生存期間と同期する要素群を統合。設定管理、グローバルエラーハンドリング、プロセス制御は全て「アプリケーション全体の責任」として単一ドメインに集約する必要がある。

### どういう効果があるのか

- **設定の一元化**: 全ドメインが参照する設定情報の整合性保証
- **初期化の制御**: 依存関係を持つ他ドメインの初期化順序制御
- **グローバル例外処理**: 予期しないエラーの最終キャッチとプロセス終了制御
- **リソース管理**: プロセス全体でのメモリ・ファイルハンドル等の管理

### ドメインの特徴

- **長期生存**: プロセス開始から終了まで持続
- **設定権威**: 他ドメインが従うべき設定値の決定権を持つ
- **制御中枢**: 他ドメインのライフサイクル制御権限
- **例外最終処理**: 他ドメインで処理できないエラーの最終処理

### 独自領域の役割

```typescript
// アプリケーション全体の状態制御
type ApplicationState = "initializing" | "running" | "shutting-down" | "terminated";

// 設定値の権威的管理
type Configuration = { readonly [K in ConfigKey]: ConfigValue<K> };

// プロセス制御の責任
type ProcessControl = {
  gracefulShutdown(): Promise<void>;
  forceTerminate(): void;
  getHealth(): SystemHealth;
};
```

### 受け渡しのイベント

**出力イベント（他ドメインへ）**:
- `initialization-completed`: 初期化完了時、全ドメインに実行開始を通知
- `configuration-changed`: 設定変更時、影響するドメインに更新を通知
- `shutdown-requested`: 終了開始時、全ドメインにクリーンアップを要求

**入力イベント（他ドメインから）**:
- `domain-error`: 各ドメインからの未処理エラー受信
- `resource-warning`: リソース枯渇警告の受信

## 2. テスト実行エンジンドメイン

### なぜこのドメインを分けたのか

**実行の中核性**: 「テスト実行」「パイプライン制御」「ステージ管理」は要件・実装共に最高頻度（24/24）で出現し、このツールの存在理由そのものである。`go test`コマンドの実行制御に特化した責任を持つ。

### どういう効果があるのか

- **Goテスト実行制御**: `go test`コマンドの構築と実行
- **即時pass判定**: 全体テスト成功時の高速完了（要求事項1対応）
- **実行単位管理**: 全体/ディレクトリ/ファイル単位の実行
- **プロセス管理**: `go test`プロセスの起動・監視・終了

### ドメインの特徴

- **コマンド実行**: `go test`プロセスの管理に特化
- **ステートレス**: 実行状態を保持せず、プロセスに委譲
- **終了コード取得**: プロセス終了コードの取得と伝達
- **出力転送**: 標準出力・エラー出力の透過的な転送

### 独自領域の役割

```typescript
// Goテストコマンドの構築
type GoTestCommand = { 
  buildCommand(target: string, env?: Record<string, string>): string[];
  execute(): Promise<{ exitCode: number }>;
};

// 実行単位の管理（ステートレス）
type ExecutionTarget = "./..." | DirectoryPath | FilePath;

// プロセス管理
type ProcessManager = { 
  spawn(command: string[]): Process;
  waitForExit(): Promise<number>;
};
```

### 受け渡しのイベント

**出力イベント**:
- `execution-started`: 実行開始時、ログ・リソースドメインに通知
- `stage-completed`: ステージ完了時、エラー処理ドメインに結果通知
- `execution-failed`: 実行失敗時、検索・拡張ドメインに修復機会提供

**入力イベント**:
- `resource-allocated`: リソース確保完了通知
- `fallback-strategy`: エラー処理ドメインからの代替実行戦略
- `similar-tests-found`: 検索ドメインからの関連テスト発見通知

## 3. エラー判定・実行制御ドメイン

### なぜこのドメインを分けたのか

**Goテスト出力の判定に特化**: 要件では中程度（20/24）だったが、実装分析で最重要（24/24）に格上げされた要素。Goテストの終了コード判定、分散実行制御は「テスト実行失敗時の戦略切替」として独立した責任を持つ。ユースケース要求の「大量エラー時の分散実行」を実現する中核。

### どういう効果があるのか

- **終了コード判定**: `go test`の終了コード（0 or 非0）による成功/失敗判定
- **実行戦略切替**: 全体実行失敗時のディレクトリ単位実行への自動切替
- **最初のエラーで中断**: エラー発見時の即座停止による効率化
- **実行単位制御**: 全体 → ディレクトリ → 個別ファイルの段階的実行

### ドメインの特徴

- **判定特化**: Goテストの終了コードベースの判定
- **戦略切替**: 実行単位の動的な変更制御
- **中断制御**: エラー時の即座停止
- **ステートレス**: 判定結果を保持せず、都度判定

### 独自領域の役割

```typescript
// Goテスト終了コードの判定
type ExitCodeChecker = { 
  isSuccess(exitCode: number): boolean; // 0 = success, non-0 = failure
};

// 実行単位の切替制御
type ExecutionUnitController = { 
  switchToDirectoryMode(): void;
  stopOnFirstError(): void;
};

// 実行戦略（ステートレス）
type ExecutionStrategy = "all-at-once" | "directory-by-directory" | "file-by-file";
```

### 受け渡しのイベント

**出力イベント**:
- `error-analyzed`: エラー分析完了時、実行エンジンに戦略提案
- `fallback-activated`: フォールバック開始時、全ドメインに制約通知
- `load-rebalanced`: 負荷再分散時、リソースドメインに要求送信

**入力イベント**:
- `execution-error`: 実行エンジンからのエラー報告
- `resource-exhausted`: リソースドメインからの枯渇警告
- `performance-degraded`: 出力ドメインからのパフォーマンス劣化通知

## 4. ファイル・リソース管理ドメイン

### なぜこのドメインを分けたのか

**基盤性と一時性**: ディレクトリ処理、ファイル操作、プロジェクト検索は「基盤機能」として他ドメインを支える。同時に、個々の操作は短時間で完了する「一時的要素」のライフサイクルを持つ。ディレクトリ階層のリスト化はユースケース要求の中核。

### どういう効果があるのか

- **ディレクトリ階層管理**: 分散実行時の階層リスト化（要求事項対応）
- **プロジェクト理解**: Go言語プロジェクト構造の自動解析
- **テストファイル検出**: エラー発生ファイルの即座の特定
- **並行安全性**: 複数ドメインからの同時ファイルアクセスの安全性保証

### ドメインの特徴

- **基盤性**: 他の全ドメインが依存する基盤サービス
- **短寿命**: 個々の操作は短時間で完了
- **並行性**: 複数の同時操作を安全に処理
- **抽象性**: ファイルシステムの詳細を隠蔽

### 独自領域の役割

```typescript
// ディレクトリ階層のリスト化
type DirectoryHierarchy = { 
  listAllDirectories(): DirectoryPath[];
  getTestFiles(dir: DirectoryPath): TestFile[];
};

// Go プロジェクト構造の理解
type ProjectStructure = { modules: GoModule[]; dependencies: Dependency[] };

// エラーファイルの特定
type ErrorFileDetector = { findFirstError(): TestFile | null };
```

### 受け渡しのイベント

**出力イベント**:
- `project-discovered`: プロジェクト構造解析完了時、実行エンジンに通知
- `resource-warning`: リソース使用量警告時、制御ドメインに通知
- `file-changed`: ファイル変更検出時、関連ドメインに通知

**入力イベント**:
- `scan-request`: 他ドメインからのディレクトリスキャン要求
- `resource-limit`: 制御ドメインからのリソース制限設定
- `cleanup-request`: 終了時の一時ファイル削除要求

## 5. 検索・統合・拡張機能ドメイン

### なぜこのドメインを分けたのか

**オプション性と外部性**: 類似ファイル検索、Serena連携は「拡張機能」として、基本機能が失敗した場合の「付加価値提供」の役割。外部依存が強く、他ドメインとは独立したライフサイクルを持つ。ユースケース要求の「類似テスト検索」を実現。

### どういう効果があるのか

- **類似テスト検索**: エラーファイルに近いテストの発見（要求事項3対応）
- **Serena活用**: 外部サービスによる高精度な類似性判定
- **バッチ実行**: 最大20ファイルまでの類似テスト並行実行
- **問題特定支援**: 関連テストの結果から問題の範囲特定

### ドメインの特徴

- **オプション性**: 基本機能に影響しない付加機能
- **外部依存**: 外部サービスへの依存が強い
- **非同期性**: 長時間実行される可能性がある処理
- **拡張性**: 新機能追加の容易さ

### 独自領域の役割

```typescript
// 類似テストファイルの検索（最大20ファイル）
type SimilarTestFinder = { 
  findSimilar(errorFile: TestFile): SimilarFile[];
  limit: 20;
};

// Serena連携による高精度検索
type SerenaSearcher = { search(file: TestFile): Promise<SimilarFile[]> };

// バッチテスト実行
type BatchTestRunner = { runTests(files: TestFile[], logLevel: "debug"): TestResults };
```

### 受け渡しのイベント

**出力イベント**:
- `similar-found`: 類似ファイル発見時、実行エンジンに提案
- `external-insight`: 外部サービスからの洞察取得時、出力ドメインに報告
- `extension-completed`: 拡張機能実行完了時、統合結果を通知

**入力イベント**:
- `test-failed`: 実行エンジンからのテスト失敗通知
- `similarity-request`: 類似ファイル検索要求
- `external-query`: 外部サービスへの問い合わせ要求

## 6. 実行環境制御ドメイン

### なぜこのドメインを分けたのか

**Go実行時の環境変数制御に特化**: `go test`実行時の環境変数設定、特にLOG_LEVEL制御は「実行時パラメータの管理」として独立した責任を持つ。ユースケース要求の「debugログ出力」を実現するための中核。本ツール自体のログではなく、Goテスト実行時の環境制御である。

### どういう効果があるのか

- **LOG_LEVEL制御**: `go test`実行時のLOG_LEVEL=debug設定（要求事項3対応）
- **環境変数管理**: テスト実行に必要な環境変数の一元管理
- **出力パススルー**: Goテストの出力をそのまま標準出力へ流す
- **実行時制御**: 通常実行とdebug実行の切替

### ドメインの特徴

- **環境制御**: `go test`実行時の環境変数設定
- **パススルー**: Goテスト出力の透過的な転送
- **ステートレス**: 環境設定を保持せず、実行時に適用
- **シンプル**: 複雑な解析や変換を行わない

### 独自領域の役割

```typescript
// Go実行時の環境変数制御
type EnvironmentController = { 
  setLogLevel(level: "debug" | "info"): void;
  getEnvironment(): Record<string, string>;
};

// Goテスト出力のパススルー
type OutputPassthrough = { 
  pipe(goTestOutput: Stream): void; // stdout/stderrをそのまま転送
};

// 実行モード切替（ステートレス）
type ExecutionMode = "normal" | "debug";
```

### 受け渡しのイベント

**出力イベント**:
- `report-ready`: レポート生成完了時、制御ドメインに完了通知
- `log-rotated`: ログローテーション時、リソースドメインに容量通知
- `format-error`: フォーマット失敗時、エラー処理ドメインに通知

**入力イベント**:
- 全ドメインからの `log-entry`: 各ドメインからのログエントリ
- 全ドメインからの `progress-update`: 進捗状況の更新
- `report-request`: レポート生成要求

## ドメイン間結合戦略

### 強結合（必須依存関係）

- **制御 → 実行**: アプリケーション制御なしに実行エンジンは動作不可
- **実行 → リソース**: ファイルアクセスなしにテスト実行は不可能
- **全て → 出力**: 全ドメインがログ出力機能に依存

### 中結合（依存注入による制御）

- **実行 → エラー処理**: 設定により有効/無効を切り替え可能
- **エラー処理 → リソース**: 分散実行時のみリソース制御が必要

### 疎結合（イベント駆動）

- **実行 → 拡張機能**: テスト失敗時のオプション機能
- **拡張機能 → 出力**: 検索結果の条件付き出力

この結合戦略により、各ドメインの独立性を保ちながら、必要な協調動作を実現する。

## ユースケース要求実現の流れ

### 完全成功パス（高速完了）
1. CLI解析・設定構築ドメインが初期化
2. テスト実行エンジンが`go test ./...`を実行
3. **終了コード0 → 即座に完了**（要求事項1）
4. Goテスト出力がそのまま標準出力へ

### エラー発生時パス（詳細分析）
1. `go test ./...`が非0終了コードを返す
2. エラー判定・実行制御ドメインが**ディレクトリ単位分割**を開始（要求事項2）
3. ファイル・リソース管理がディレクトリ階層をリスト化
4. 各ディレクトリで`go test`実行、**最初のエラーで中断**
5. 検索・統合・拡張機能ドメインが**Serenaで類似テスト検索**（要求事項3）
6. **最大20ファイル**の類似テストを**LOG_LEVEL=debug**で`go test`実行
7. 実行環境制御ドメインが環境変数を設定し、**Goテスト出力をそのまま転送**

## 設計品質指標

### 分離度評価
- [ ] 各ドメインが独立してテスト可能
- [ ] ドメイン境界を越えた直接的な状態共有なし
- [ ] イベント駆動による疎結合の実現

### 凝集度評価  
- [ ] 各ドメイン内の要素が単一の責任を共有
- [ ] ライフサイクルの一貫性
- [ ] 変更理由の単一性

### ステートレス性評価
- [ ] 内部メモリを持たない設計
- [ ] 実行結果の保持なし（都度判定）
- [ ] Goテスト出力の透過的な転送

### ユースケース要求充足評価
- [ ] CI完了速度の向上（`go test ./...`の即時完了）
- [ ] 詳細分析精度の向上（ディレクトリ単位での`go test`実行）
- [ ] 問題把握容易性の向上（LOG_LEVEL=debugでの`go test`実行）

この設計により、Goテスト実行ラッパーとしての本質的な責任に集中し、内部状態を持たないシンプルで効率的なCIツールの実装基盤が確立される。