# ドメイン境界線の設計統合版

## 概要

Go言語CIツールにおけるドメイン境界線を、要件分析と実装コード分析の両面から統合的に設計する。
ドメイン駆動設計に基づき、「出現分布」「中心骨格」「ライフサイクル」「イベント境界」の4つの軸で分析を行う。

## 統合出現分布分析

### 要件ベース vs 実装ベース対照表

| 要素 | 要件頻度 | 実装頻度 | 統合評価 |
|------|----------|----------|----------|
| テスト実行 | 24/24 | 24/24 | **最重要コア** |
| エラー処理・判定 | 20/24 | 24/24 | **最重要コア** |
| 結果出力・管理 | 24/24 | 24/24 | **最重要コア** |
| ディレクトリ処理 | 16/24 | 20/24 | **重要要素** |
| ファイル検索・分類 | 12/24 | 8/24 | **中核要素** |
| 分散実行制御 | 8/24 | 20/24 | **実装重要** |
| 外部連携（Serena） | 8/24 | 8/24 | **拡張機能** |

### 統合中心要素特定

**最重要コア（両面で最高頻度）**
- テスト実行エンジン
- エラー処理・判定システム  
- 結果出力・管理システム

**重要要素（高頻度）**
- ディレクトリ階層処理
- 分散実行制御（実装で重要性発見）
- CLI・設定管理（実装で必須性発見）

## 統合中心骨格の特定

### 主要骨格（最短実行経路）
1. **要件主要骨格**: テスト実行 → エラー判定 → 結果出力
2. **実装主要骨格**: CLI解析 → 設定構築 → GoCI実行 → 成功終了
3. **統合主要骨格**: **CLI解析 → テスト実行 → エラー判定 → 結果出力**

### 補助骨格統合
- **エラー対応骨格**: エラー検出 → 分散実行 → フォールバック → 継続実行
- **拡張機能骨格**: テスト失敗 → 類似ファイル検索 → 並行テスト実行 → 結果統合
- **実行制御骨格**: 実行モード判定 → all/batch/single-package分岐 → ディレクトリ単位処理

## 統合距離判定（2軸分析）

### 縦軸（実行ステップ深さ）統合版
- **Level 1**: CLI解析、テスト実行エンジン、結果出力
- **Level 2**: 設定構築、エラー判定、分散制御  
- **Level 3**: ディレクトリ処理、ファイル検索、ステージ実行
- **Level 4**: Serena連携、類似ファイル検索、結果統合
- **Level 5**: フォールバック処理、並行テスト実行

### 横軸（意味的距離）統合版
- **Core (距離0)**: テスト実行エンジン、エラー判定、結果管理
- **Near (距離1)**: CLI処理、設定管理、ログ制御
- **Mid (距離2)**: ディレクトリ管理、ファイル操作、分散実行制御
- **Far (距離3)**: 外部検索連携、拡張機能、統合処理

## 統合ライフサイクル分析

### 永続的要素（プロセス全体ライフサイクル）
- **要件**: テスト設定・構成、ディレクトリ構造情報、実行履歴
- **実装**: CLI設定オブジェクト、ロガーインスタンス、実行エンジンインスタンス
- **統合**: **アプリケーション設定、実行コンテキスト、永続サービス**

### セッション要素（実行セッションライフサイクル）  
- **要件**: テスト実行セッション、エラー分析結果、分散実行状態
- **実装**: パイプライン実行状態、パッケージリスト、実行結果コレクション
- **統合**: **パイプライン実行状態、エラー分析コンテキスト、実行セッション管理**

### 一時的要素（ステージ・タスクライフサイクル）
- **要件**: 個別テスト結果、一時的なファイルリスト、リアルタイム出力
- **実装**: プロセス実行結果、ステージ実行時間、個別コマンド実行
- **統合**: **ステージ実行結果、個別タスク状態、一時データ**

### 外部依存要素（オンデマンドライフサイクル）
- **要件**: Serena連携結果、バッチ処理結果
- **実装**: Serenaクライアント接続、類似ファイル検索結果、並行実行プロミス
- **統合**: **外部サービス連携、オンデマンドリソース、拡張機能状態**

## 統合イベント境界の特定

### 主要イベント境界統合版
1. **CLI解析完了イベント** → 設定構築・初期化
2. **テスト実行開始イベント** → パッケージ検査・準備
3. **テスト完了イベント** → エラー判定プロセス
4. **エラー検出イベント** → 分散実行・フォールバック開始
5. **ディレクトリ処理完了イベント** → 次階層処理・ステージ遷移
6. **検索・類似ファイル発見イベント** → バッチテスト実行
7. **結果統合イベント** → 最終出力・プロセス終了

## 統合ドメイン境界線の設定

### 1. アプリケーション制御ドメイン
- **統合責務**: アプリケーション全体の制御フロー、CLI処理、初期化制御
- **要件マッピング**: エントリーポイント制御
- **実装マッピング**: main.ts、cli-parser.ts
- **境界**: CLI解析完了イベント、アプリケーション初期化完了イベント
- **構成要素**: CLI解析、設定構築、グローバルエラーハンドリング、プロセス制御

### 2. テスト実行エンジンドメイン
- **統合責務**: テスト実行、パイプライン制御、ステージ管理
- **要件マッピング**: テストエンジンドメイン
- **実装マッピング**: go-ci.ts（コア部分）
- **境界**: テスト実行開始イベント、テスト完了イベント、ステージ遷移イベント
- **構成要素**: パイプライン実行、ステージ制御、テスト実行、結果判定

### 3. エラー処理・分散制御ドメイン
- **統合責務**: エラー分析、分散実行制御、フォールバック処理、実行モード制御
- **要件マッピング**: エラー処理・分散制御ドメイン
- **実装マッピング**: go-ci.ts（実行モード・フォールバック部分）
- **境界**: エラー検出イベント、分散実行開始イベント、フォールバック完了イベント
- **構成要素**: エラー判定、分散実行制御、実行モード分岐、フォールバック処理

### 4. ファイル・リソース管理ドメイン
- **統合責務**: ディレクトリ階層管理、ファイル操作、プロジェクト検索、システムリソース管理
- **要件マッピング**: ファイル・ディレクトリ管理ドメイン
- **実装マッピング**: file-system-service.ts、go-project-discovery.ts、process-runner.ts
- **境界**: ディレクトリ処理完了イベント、ファイル操作要求イベント
- **構成要素**: ディレクトリ階層処理、ファイル操作、プロジェクト検索、プロセス実行

### 5. 検索・統合・拡張機能ドメイン
- **統合責務**: 類似ファイル検索、外部サービス連携、結果統合、拡張機能制御
- **要件マッピング**: 検索・統合ドメイン
- **実装マッピング**: similar-test-finder.ts、serena-mcp-client.ts
- **境界**: 検索開始イベント、検索完了イベント、統合完了イベント
- **構成要素**: Serena連携、類似ファイル検索、並行テスト実行、結果統合（最大20ファイル制限）

### 6. 出力・ログ管理ドメイン
- **統合責務**: ログ制御、結果フォーマット、出力管理、レポート生成
- **要件マッピング**: 出力・結果管理ドメイン
- **実装マッピング**: go-ci-logger.ts、log-mode.ts
- **境界**: ログ出力要求イベント、結果出力イベント
- **構成要素**: ログ制御、結果フォーマット、出力管理、レポート生成

## 統合ドメイン間結合方針

### 強結合（必須依存）
- **アプリケーション制御 → テスト実行エンジン**: 必須のアプリケーションフロー
- **テスト実行エンジン → ファイル・リソース管理**: 実行に必要なリソースアクセス
- **すべてのドメイン → 出力・ログ管理**: 横断的なログ機能

### 中結合（依存注入・制御反転）
- **テスト実行エンジン → エラー処理・分散制御**: 設定による制御切り替え
- **エラー処理・分散制御 → ファイル・リソース管理**: 分散実行時のリソース制御

### 疎結合（イベント駆動）
- **テスト実行エンジン → 検索・統合・拡張機能**: テスト失敗時のオプション機能
- **エラー処理・分散制御 ⟷ 検索・統合・拡張機能**: エラー時の拡張処理
- **検索・統合・拡張機能 → 出力・ログ管理**: 検索結果の条件出力

## 実装改善提案（統合版）

### 現在の境界違反と課題
1. **go-ci.ts の責務過多**: パイプライン制御 + ステージ実行 + エラー処理 + 結果管理（833行）
2. **ライフサイクル混在**: 永続要素と一時要素の同一クラス管理
3. **外部依存の強結合**: 拡張機能の直接インスタンス化
4. **イベント境界の実装不足**: 同期処理による密結合

### 統合改善方針
1. **ドメイン分離の徹底**: 
   - PipelineExecutor（実行制御）
   - StageManager（ステージ管理）
   - ErrorHandler（エラー・分散制御）
   - ResultAggregator（結果統合）

2. **イベント駆動アーキテクチャの導入**:
   - EventEmitter/Observableによるドメイン間疎結合
   - 非同期イベント境界の明確化

3. **依存注入コンテナの導入**:
   - 拡張機能の外部化とDI管理
   - ライフサイクル別コンテナ分離

4. **責務境界の明確化**:
   - 単一責任原則の徹底
   - インターフェース分離による疎結合化

ライフサイクルの違いを考慮し、永続的要素と揮発性要素を適切に分離し、イベント境界によるドメイン間疎結合を実現する設計とする。